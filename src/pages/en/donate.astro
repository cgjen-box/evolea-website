---
import Base from '@layouts/Base.astro';
import InnerPageHero from '@components/InnerPageHero.astro';
import PageCloser from '@components/PageCloser.astro';
import Icon from '@components/Icon.astro';
import EditLink from '@components/EditLink.astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '@i18n/utils';
import { getEntry } from 'astro:content';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Get CMS content
const spendenEntry = await getEntry('pages', 'spenden');
const page = spendenEntry?.data;

// Hero image
const heroImage = base + '/images/hero/spenden-hero.png';

// Helper to get bilingual text
const getText = (obj: { de?: string; en?: string } | undefined, fallback: string = '') => {
  if (!obj) return fallback;
  return lang === 'de' ? (obj.de || fallback) : (obj.en || obj.de || fallback);
};

// Bank details - DO NOT MODIFY (hardcoded per policy)
const bankDetails = {
  name: 'EVOLEA Verein',
  address: 'Stapferstrasse 10, 8006 Zürich',
  bank: 'UBS Switzerland AG',
  iban: 'CH90 0023 0230 9206 9201 G',
  bic: 'UBSWCHZH80A',
};

// Color classes for why donate cards
const cardColorClasses: Record<string, { bg: string; icon: string }> = {
  purple: { bg: 'bg-evolea-purple/10', icon: 'text-evolea-purple' },
  mint: { bg: 'bg-evolea-mint/20', icon: 'text-evolea-mint' },
  coral: { bg: 'bg-evolea-coral/20', icon: 'text-evolea-coral' },
};
---

<Base
  title={getText(page?.hero?.titel, "Support EVOLEA")}
  description={getText(page?.hero?.untertitel, "Your donation enables children on the spectrum to access our programs.")}
  transparentHeader={true}
  hideFooterCTA={true}
>
  <!-- Premium Hero with Prism Gradient and Image -->
  <InnerPageHero
    title={getText(page?.hero?.titel, "Support EVOLEA")}
    subtitle={getText(page?.hero?.untertitel, "Your donation enables children on the spectrum to access our programs.")}
    breadcrumbs={[
      { label: t('nav.home'), href: translatePath('/') },
      { label: t('nav.donate') }
    ]}
    label={getText(page?.hero?.label, "Donate")}
    size="md"
    heroImage={heroImage}
    heroImageAlt="Children at EVOLEA projects"
  />

  <!-- ===== SUCCESS STORY: What We've Achieved ===== -->
  <section class="py-16 md:py-24 bg-white">
    <div class="container mx-auto max-w-6xl px-4">
      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <!-- Instagram Reel Embed -->
        <div class="instagram-embed-wrapper">
          <div class="instagram-reel-container rounded-evolea-lg overflow-hidden shadow-elevated">
            <iframe
              src={page?.successStory?.instagramReelUrl || "https://www.instagram.com/reel/DRcoCiaDJ-r/embed/"}
              class="instagram-reel-iframe"
              frameborder="0"
              scrolling="no"
              allowtransparency="true"
              allowfullscreen="true"
              title="EVOLEA Mini Restaurant - Instagram Reel"
            ></iframe>
          </div>
        </div>

        <!-- Story Content -->
        <div>
          <span class="inline-block text-sm font-semibold text-evolea-purple uppercase tracking-wider mb-4">
            {getText(page?.successStory?.label, "What We've Achieved")}
          </span>
          <h2 class="text-3xl md:text-4xl font-display font-bold text-evolea-purple mb-6 leading-tight">
            {getText(page?.successStory?.titel, "Mini Restaurant: 10 Weeks That Matter")}
          </h2>
          <p class="text-lg text-evolea-text-light mb-4 leading-relaxed">
            {getText(page?.successStory?.text1, "Cooking. Serving. Cleaning up. Sounds simple. For children on the spectrum, it's a huge step.")}
          </p>
          <p class="text-lg text-evolea-text-light mb-6 leading-relaxed">
            {getText(page?.successStory?.text2, "For 10 weeks, children cooked together, took on roles, and built social skills. Not in theory. In real life.")}
          </p>

          <!-- Impact List -->
          <ul class="space-y-4">
            {(page?.successStory?.impactItems || []).map((item: { icon: string; text: { de?: string; en?: string } }) => (
              <li class="flex items-center gap-4">
                <div class="w-12 h-12 bg-evolea-purple/10 rounded-full flex items-center justify-center flex-shrink-0">
                  <Icon name={item.icon as 'people' | 'calendar' | 'sparkle' | 'heart' | 'check'} size="md" />
                </div>
                <span class="font-medium text-evolea-text">{getText(item.text, '')}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== WHY DONATE: Why Your Help Matters ===== -->
  <section class="py-16 md:py-24 bg-evolea-cream/50">
    <div class="container mx-auto max-w-5xl px-4">
      <div class="text-center mb-12">
        <span class="inline-block text-sm font-semibold text-evolea-purple uppercase tracking-wider mb-4">
          {getText(page?.whyDonate?.label, "Why Your Help Matters")}
        </span>
        <h2 class="text-3xl md:text-4xl font-display font-bold text-evolea-purple mb-4">
          {getText(page?.whyDonate?.titel, "Your donation reduces the cost for parents")}
        </h2>
      </div>

      <div class="grid md:grid-cols-3 gap-8">
        {(page?.whyDonate?.karten || []).map((karte: { titel: { de?: string; en?: string }; text: { de?: string; en?: string }; farbe: string }) => {
          const colors = cardColorClasses[karte.farbe] || cardColorClasses.purple;
          return (
            <div class="bg-white rounded-evolea-lg p-8 shadow-soft hover:shadow-elevated transition-shadow">
              <div class={`w-16 h-16 ${colors.bg} rounded-full flex items-center justify-center mb-6`}>
                <svg class={`w-8 h-8 ${colors.icon}`} fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
              </div>
              <h3 class="text-xl font-display font-bold text-evolea-purple mb-3">{getText(karte.titel, '')}</h3>
              <p class="text-evolea-text-light leading-relaxed">
                {getText(karte.text, '')}
              </p>
            </div>
          );
        })}
      </div>
    </div>
  </section>

  <!-- ===== UPCOMING PROJECTS: What's Coming Next ===== -->
  <section class="py-16 md:py-24 bg-white">
    <div class="container mx-auto max-w-5xl px-4">
      <div class="text-center mb-12">
        <span class="inline-block text-sm font-semibold text-evolea-purple uppercase tracking-wider mb-4">
          {getText(page?.upcomingProjects?.label, "What's Coming Next")}
        </span>
        <h2 class="text-3xl md:text-4xl font-display font-bold text-evolea-purple mb-4">
          {getText(page?.upcomingProjects?.titel, "Two Projects Waiting for You")}
        </h2>
        <p class="text-lg text-evolea-text-light max-w-2xl mx-auto">
          {getText(page?.upcomingProjects?.intro, "The Mini Restaurant worked. Now we want to continue. With your help, these two programs will launch.")}
        </p>
      </div>

      <div class="grid md:grid-cols-2 gap-8">
        <!-- Mini Turnen -->
        <div class="group relative bg-evolea-cream/50 rounded-evolea-lg p-8 border-2 border-transparent hover:border-evolea-purple transition-all">
          <span class="absolute top-4 right-4 text-xs font-semibold text-white bg-evolea-purple px-3 py-1 rounded-full">
            Start: January 2025
          </span>

          <div class="w-16 h-16 bg-evolea-mint/20 rounded-full flex items-center justify-center mb-6">
            <Icon name="running" size="lg" />
          </div>

          <h3 class="text-2xl font-display font-bold text-evolea-purple mb-2">Mini Turnen</h3>
          <p class="text-evolea-purple font-medium italic mb-4">Movement. In a group that understands.</p>

          <p class="text-evolea-text-light mb-4">
            Sports in a club? For many children on the spectrum, unthinkable.
            Too loud, too chaotic, too many unwritten rules.
          </p>
          <p class="text-evolea-text-light mb-6">
            Mini Turnen is different. Small group. Clear structure.
            And adults who know what they're doing.
          </p>

          <div class="flex flex-wrap gap-2 mb-6">
            <span class="text-sm bg-white px-3 py-1 rounded-full text-evolea-text">Wednesdays 18:30</span>
            <span class="text-sm bg-white px-3 py-1 rounded-full text-evolea-text">Ages 5-8</span>
            <span class="text-sm bg-white px-3 py-1 rounded-full text-evolea-text">Small Group</span>
          </div>

          <a href={translatePath('/angebote/mini-turnen/')} class="inline-flex items-center gap-2 font-semibold text-evolea-purple hover:gap-3 transition-all">
            Learn more
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>

        <!-- Mini Museum -->
        <div class="group relative bg-evolea-cream/50 rounded-evolea-lg p-8 border-2 border-transparent hover:border-evolea-purple transition-all">
          <span class="absolute top-4 right-4 text-xs font-semibold text-white bg-evolea-purple px-3 py-1 rounded-full">
            Start: February 2026
          </span>

          <div class="w-16 h-16 bg-evolea-magenta/10 rounded-full flex items-center justify-center mb-6">
            <Icon name="museum" size="lg" />
          </div>

          <h3 class="text-2xl font-display font-bold text-evolea-purple mb-2">Mini Museum</h3>
          <p class="text-evolea-purple font-medium italic mb-4">Make art. Show art. Be proud.</p>

          <p class="text-evolea-text-light mb-4">
            Creativity doesn't need small talk.
            At Mini Museum, children work on their own art projects.
            And then show them in a real exhibition.
          </p>
          <p class="text-evolea-text-light mb-6">
            The focus: Creating, not talking.
            Making something of your own and being seen for it.
          </p>

          <div class="flex flex-wrap gap-2 mb-6">
            <span class="text-sm bg-white px-3 py-1 rounded-full text-evolea-text">Saturdays 09:00</span>
            <span class="text-sm bg-white px-3 py-1 rounded-full text-evolea-text">Every 2 weeks</span>
            <span class="text-sm bg-white px-3 py-1 rounded-full text-evolea-text">Ages 5-8</span>
          </div>

          <a href={translatePath('/angebote/mini-museum/')} class="inline-flex items-center gap-2 font-semibold text-evolea-purple hover:gap-3 transition-all">
            Learn more
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== HOW TO DONATE: How to Help ===== -->
  <section id="donate-section" class="py-16 md:py-24 donate-section">
    <div class="container mx-auto max-w-6xl px-4">
      <div class="grid lg:grid-cols-5 gap-12">
        <!-- Bank Details (3 cols) -->
        <div class="lg:col-span-3">
          <span class="inline-block text-sm font-semibold text-evolea-lavender uppercase tracking-wider mb-4">
            {getText(page?.howToDonate?.label, "How to Help")}
          </span>
          <h2 class="text-3xl md:text-4xl font-display font-bold text-white mb-4">
            {getText(page?.howToDonate?.titel, "Direct. Simple. Effective.")}
          </h2>
          <p class="text-lg text-white/90 mb-8">
            {getText(page?.howToDonate?.intro, "No complicated online platform. Just transfer. Every franc arrives.")}
          </p>

          <!-- Bank Details Card -->
          <div class="bg-white/10 backdrop-blur-sm rounded-evolea-lg p-6 mb-6">
            <h3 class="font-display font-bold text-white text-lg mb-4">
              {getText(page?.howToDonate?.bankSectionTitle, "Bank Details")}
            </h3>

            <div class="space-y-3">
              <div class="flex justify-between items-start py-3 border-b border-white/10">
                <span class="text-white/70 text-sm">{getText(page?.howToDonate?.kontoinhaber, "Account Holder")}</span>
                <span class="text-white font-semibold text-right">
                  {bankDetails.name}<br/>
                  <span class="font-normal text-sm">{bankDetails.address}</span>
                </span>
              </div>
              <div class="flex justify-between items-center py-3 border-b border-white/10">
                <span class="text-white/70 text-sm">{getText(page?.howToDonate?.ibanLabel, "IBAN")}</span>
                <span class="text-white font-mono font-semibold">{bankDetails.iban}</span>
              </div>
              <div class="flex justify-between items-center py-3 border-b border-white/10">
                <span class="text-white/70 text-sm">{getText(page?.howToDonate?.bankLabel, "Bank")}</span>
                <span class="text-white font-semibold">{bankDetails.bank}</span>
              </div>
              <div class="flex justify-between items-center py-3 border-b border-white/10">
                <span class="text-white/70 text-sm">{getText(page?.howToDonate?.bicLabel, "BIC/SWIFT")}</span>
                <span class="text-white font-mono font-semibold">{bankDetails.bic}</span>
              </div>
              <div class="flex justify-between items-center py-3">
                <span class="text-white/70 text-sm">{getText(page?.howToDonate?.verwendungszweckLabel, "Reference")}</span>
                <span class="text-white font-semibold">{getText(page?.howToDonate?.verwendungszweck, "Donation EVOLEA")}</span>
              </div>
            </div>
          </div>

          <!-- Tax Info -->
          <div class="bg-white/5 border border-white/10 rounded-evolea-lg p-6">
            <h3 class="font-display font-bold text-white text-lg mb-4">
              {getText(page?.howToDonate?.gutZuWissenTitel, "Good to Know")}
            </h3>
            <ul class="space-y-3">
              {(page?.howToDonate?.taxInfo || []).map((info: { label: { de?: string; en?: string }; text: { de?: string; en?: string } }) => (
                <li class="flex items-start gap-3 text-white/90">
                  <svg class="w-5 h-5 text-evolea-yellow flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <span><strong class="text-white">{getText(info.label, '')}:</strong> {getText(info.text, '')}</span>
                </li>
              ))}
            </ul>
          </div>
        </div>

        <!-- Donation Amounts Card (2 cols) -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-evolea-lg p-8 shadow-elevated">
            <h3 class="text-xl font-display font-bold text-evolea-purple text-center mb-6">
              {getText(page?.donationAmounts?.titel, "What Your Donation Achieves")}
            </h3>

            <div class="space-y-3">
              {(page?.donationAmounts?.betraege || []).map((betrag: { betrag: string; beschreibung: { de?: string; en?: string }; highlighted: boolean }) => (
                <div class={`flex justify-between items-center p-4 rounded-evolea ${betrag.highlighted ? 'bg-gradient-to-r from-evolea-yellow to-evolea-coral/80' : 'bg-evolea-cream/50'}`}>
                  <span class="font-display font-bold text-evolea-purple text-lg">{betrag.betrag}</span>
                  <span class={`text-sm text-right ${betrag.highlighted ? 'text-evolea-text font-medium' : 'text-evolea-text-light'}`}>
                    {getText(betrag.beschreibung, '')}
                  </span>
                </div>
              ))}
            </div>

            <!-- Copy IBAN Button -->
            <button
              id="copy-iban-btn"
              class="mt-6 w-full py-3 px-6 bg-evolea-purple text-white font-semibold rounded-full hover:bg-evolea-purple/90 transition-colors flex items-center justify-center gap-2"
              data-iban={bankDetails.iban.replace(/\s/g, '')}
            >
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
              </svg>
              <span id="copy-text">{getText(page?.donationAmounts?.buttonText, "Copy IBAN")}</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== CONTACT PERSON ===== -->
  <section class="py-16 md:py-20 bg-evolea-cream/50">
    <div class="container mx-auto max-w-2xl px-4">
      <div class="flex flex-col md:flex-row items-center gap-8 text-center md:text-left">
        <div class="w-32 h-32 rounded-full overflow-hidden shadow-elevated flex-shrink-0 bg-white">
          <img
            src={`${base}${page?.contactPerson?.foto || '/images/team/gianna-spiess.png'}`}
            alt={page?.contactPerson?.name || 'Gianna Spiess'}
            class="w-full h-full object-cover"
          />
        </div>
        <div>
          <h3 class="font-display font-bold text-evolea-purple text-xl mb-1">
            {getText(page?.contactPerson?.titel, "Questions? Just ask.")}
          </h3>
          <p class="font-semibold text-evolea-purple text-lg">{page?.contactPerson?.name || 'Gianna Spiess'}</p>
          <p class="text-evolea-text-light text-sm mb-3">{getText(page?.contactPerson?.rolle, "M.Sc., BCBA – Co-Founder")}</p>
          <p class="text-evolea-text-light mb-4">
            {getText(page?.contactPerson?.text, "Want to know where your donation goes? Have an idea for collaboration? Write to me.")}
          </p>
          <a href={`mailto:${page?.contactPerson?.email || 'hello@evolea.ch'}`} class="inline-flex items-center gap-2 font-semibold text-evolea-purple hover:underline">
            {page?.contactPerson?.email || 'hello@evolea.ch'}
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Page Closer with custom message -->
  <PageCloser
    showCTA={true}
    ctaTitle={getText(page?.cta?.titel, "Children don't need a perfect world.")}
    ctaDescription={getText(page?.cta?.beschreibung, "They need spaces that fit them. You can create one.")}
    ctaButtonText={getText(page?.cta?.buttonText, "I want to help")}
    ctaButtonHref="#donate-section"
  />

  <!-- Edit Link for Keystatic -->
  <EditLink type="singleton" collection="spenden" label="Edit Spenden" />
</Base>


<script>
  const copyBtn = document.getElementById('copy-iban-btn');
  const copyText = document.getElementById('copy-text');

  if (copyBtn && copyText) {
    copyBtn.addEventListener('click', async () => {
      const iban = copyBtn.getAttribute('data-iban');
      if (iban) {
        try {
          await navigator.clipboard.writeText(iban);
          const originalText = copyText.textContent;
          copyText.textContent = 'Copied!';
          copyBtn.classList.add('bg-evolea-green', 'hover:bg-evolea-green/90');
          copyBtn.classList.remove('bg-evolea-purple', 'hover:bg-evolea-purple/90');

          setTimeout(() => {
            copyText.textContent = originalText;
            copyBtn.classList.remove('bg-evolea-green', 'hover:bg-evolea-green/90');
            copyBtn.classList.add('bg-evolea-purple', 'hover:bg-evolea-purple/90');
          }, 2000);
        } catch (err) {
          console.error('Failed to copy:', err);
        }
      }
    });
  }
</script>

<style>
  /* Donate Section Gradient Background */
  .donate-section {
    background: linear-gradient(135deg, #BA53AD 0%, #8A3D7E 50%, #5C2854 100%);
    position: relative;
  }

  /* Instagram Reel Container */
  .instagram-embed-wrapper {
    display: flex;
    justify-content: center;
  }

  .instagram-reel-container {
    position: relative;
    width: 100%;
    max-width: 400px;
    background: #FFFBF7;
  }

  /* Aspect ratio container for reel (9:16 vertical video) */
  .instagram-reel-container::before {
    content: "";
    display: block;
    padding-top: 177.78%; /* 16:9 inverted = 9:16 aspect ratio */
  }

  .instagram-reel-iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: none;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .instagram-reel-container {
      max-width: 100%;
    }
  }
</style>
