---
import Base from '@layouts/Base.astro';
import FloatingShapes from '@components/FloatingShapes.astro';
import Icon from '@components/Icon.astro';
import EditLink from '@components/EditLink.astro';
import { getLangFromUrl, useTranslatedPath } from '@i18n/utils';
import { getEntry } from 'astro:content';

const lang = getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(lang);
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Get CMS content
const pageEntry = await getEntry('pages', 'mini-museum');
const page = pageEntry?.data;

// Get site images from CMS
const siteImagesEntry = await getEntry('settings', 'images');
const siteImages = siteImagesEntry?.data;
const heroImage = siteImages?.programmeHeroes?.miniMuseum
  ? base + siteImages.programmeHeroes.miniMuseum
  : base + "/images/programs/mini-museum-hero.png";

// Helper to get bilingual text
const getText = (obj: { de?: string; en?: string } | undefined, fallback: string = '') => {
  if (!obj) return fallback;
  return lang === 'de' ? (obj.de || fallback) : (obj.en || obj.de || fallback);
};

// Page content with fallbacks
const hero = page?.hero || {};
const infoKarten = page?.infoKarten || [];
const konzept = page?.konzept || {};
const ablauf = page?.ablauf || {};
const ziele = page?.ziele || {};
const aufnahme = page?.aufnahme || {};
const praktischeInfos = page?.praktischeInfos || {};

// Schedule data from CMS
const schedule = (ablauf.termine || []).map((termin: any) => ({
  day: termin.tag,
  title: getText(termin.titel),
  date: getText(termin.datum),
  time: termin.zeit,
  focus: getText(termin.fokus),
  location: getText(termin.standort),
  isSpecial: termin.istBesonders
}));

// Color mappings for skills
const skillColors: Record<string, string> = {
  mint: 'bg-evolea-mint/20',
  coral: 'bg-evolea-coral/20',
  purple: 'bg-evolea-purple/20',
  orange: 'bg-evolea-orange/20'
};
---

<Base title={`${hero.titel || 'Mini Museum'} - Mini Projekte`} description={getText(hero.beschreibung, 'Mini Museum: Wir werden kreativ! Ein inklusives Kunstprojekt für Kinder im Autismus-Spektrum (5-8 Jahre). Gemeinsam ein eigenes Museum gestalten und eröffnen.')}>
  <!-- Hero Section -->
  <section class="relative py-20 md:py-28 bg-gradient-to-br from-evolea-lavender/10 to-evolea-cream overflow-hidden">
    <FloatingShapes variant="minimal" />
    <div class="container mx-auto max-w-6xl px-4 relative z-10">
      <nav class="mb-8 text-sm text-evolea-text-light">
        <a href={translatePath('/')} class="hover:text-evolea-purple transition-colors">{lang === 'de' ? 'Startseite' : 'Home'}</a>
        <span class="mx-2">/</span>
        <a href={translatePath('/angebote/')} class="hover:text-evolea-purple transition-colors">{lang === 'de' ? 'Angebote' : 'Programs'}</a>
        <span class="mx-2">/</span>
        <a href={translatePath('/angebote/mini-projekte/')} class="hover:text-evolea-purple transition-colors">Mini Projekte</a>
        <span class="mx-2">/</span>
        <span class="text-evolea-purple font-medium">{hero.titel || 'Mini Museum'}</span>
      </nav>

      <div class="grid lg:grid-cols-2 gap-12 items-center">
        <div>
          <div class="inline-flex items-center gap-2 bg-evolea-lavender/20 text-evolea-lavender px-4 py-2 rounded-full text-sm font-medium mb-6">
            <Icon name="palette" size="sm" />
            <span>{getText(hero.badge, 'Kreatives Kunstprojekt')}</span>
          </div>
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-display font-bold text-evolea-purple mb-6 leading-tight">
            {hero.titel || 'Mini Museum'}
          </h1>
          <p class="text-xl md:text-2xl text-evolea-text-light mb-4 leading-relaxed">
            {getText(hero.untertitel, 'Wir werden kreativ!')}
          </p>
          <p class="text-lg text-evolea-text-light mb-8">
            {getText(hero.beschreibung, 'In diesem inklusiven Projekt gestalten Kinder ihr eigenes Museum. Sie wählen Themen, sammeln Kunstwerke, erstellen Ausstellungen und führen Besucher durch ihre Galerie.')}
          </p>
          <div class="flex flex-wrap gap-4">
            <a href={hero.buttonLink || `${base}/kontakt/?programm=mini-museum`} class="btn-primary">
              {getText(hero.buttonText, 'Jetzt anmelden')}
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
              </svg>
            </a>
            <a href={hero.zweitButtonLink || '#programm'} class="btn-outline">
              {getText(hero.zweitButtonText, 'Programm ansehen')}
            </a>
          </div>
        </div>
        <div class="relative">
          <img
            src={heroImage}
            alt={getText(hero.untertitel, 'Kinder beim kreativen Gestalten im Mini Museum')}
            class="rounded-evolea-lg shadow-elevated w-full object-cover aspect-4/3"
          />
          <div class="absolute -bottom-4 -right-4 bg-white rounded-evolea p-4 shadow-card">
            <div class="text-3xl font-display font-bold text-evolea-lavender">{hero.alter || '5-8'}</div>
            <div class="text-sm text-evolea-text-light">{lang === 'de' ? 'Jahre' : 'Years'}</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Key Info Cards -->
  <section class="py-16 bg-white">
    <div class="container mx-auto max-w-6xl px-4">
      <div class="grid md:grid-cols-4 gap-6">
        {infoKarten.map((karte: any) => (
          <div class="bg-evolea-cream rounded-evolea-lg p-6 text-center">
            <div class="flex justify-center mb-3"><Icon name={karte.icon || 'sparkle'} size="lg" /></div>
            <div class="font-display font-bold text-evolea-purple text-lg">{getText(karte.label, '')}</div>
            <div class="text-evolea-text-light">{getText(karte.wert, '')}</div>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Program Concept -->
  <section class="py-16 md:py-24 bg-evolea-cream/30">
    <div class="container mx-auto max-w-4xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-display font-bold text-evolea-purple mb-4">
          {getText(konzept.titel, 'Das Konzept')}
        </h2>
        <p class="text-lg text-evolea-text-light max-w-2xl mx-auto">
          {getText(konzept.untertitel, 'Ein Ort an dem Kinder wachsen und Familien aufatmen können.')}
        </p>
      </div>

      <div class="prose prose-lg max-w-none text-evolea-text-light mb-12">
        {(konzept.absaetze || []).map((absatz: any) => (
          <p set:html={getText(absatz, '')} />
        ))}
      </div>

      <div class="grid md:grid-cols-2 gap-6">
        {(konzept.faehigkeiten || []).map((skill: any) => (
          <div class="bg-white rounded-evolea-lg p-6 shadow-soft">
            <div class="flex justify-center mb-4">
              <div class={`w-12 h-12 ${skillColors[skill.farbe] || 'bg-evolea-purple/20'} rounded-full flex items-center justify-center`}>
                <Icon name={skill.icon || 'sparkle'} size="md" />
              </div>
            </div>
            <h3 class="font-display font-bold text-evolea-purple text-lg mb-2 text-center">{getText(skill.titel, '')}</h3>
            <p class="text-evolea-text-light text-center mb-0">{getText(skill.beschreibung, '')}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Program Schedule -->
  <section class="py-16 md:py-24" id="programm">
    <div class="container mx-auto max-w-4xl px-4">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-display font-bold text-evolea-purple mb-4">
          {getText(ablauf.titel, 'Der Ablauf')}
        </h2>
        <p class="text-lg text-evolea-text-light">
          {getText(ablauf.untertitel, '6 Halbtage voller Kunst, Kreativität und Entdeckungen')}
        </p>
      </div>

      <div class="space-y-4">
        {schedule.map((session: { day: number; title: string; date: string; time: string; focus: string; location: string; isSpecial?: boolean }) => (
          <div class={`rounded-evolea-lg p-6 border-l-4 ${session.isSpecial ? 'bg-gradient-to-r from-evolea-magenta/10 to-evolea-coral/10 border-evolea-magenta' : 'bg-white border-evolea-purple shadow-soft'}`}>
            <div class="flex flex-col md:flex-row md:items-center gap-4">
              <div class={`flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center font-display font-bold text-lg ${session.isSpecial ? 'bg-evolea-magenta text-white' : 'bg-evolea-purple/20 text-evolea-purple'}`}>
                {session.day}
              </div>
              <div class="flex-grow">
                <h3 class="font-display font-bold text-evolea-purple text-lg mb-1">
                  {session.title}
                  {session.isSpecial && <span class="ml-2 text-sm bg-evolea-magenta/20 text-evolea-magenta px-2 py-0.5 rounded-full">Eröffnungsfeier</span>}
                </h3>
                <p class="text-evolea-text-light text-sm mb-2">{session.focus}</p>
                <div class="flex flex-wrap gap-4 text-sm text-evolea-text-light">
                  <span class="flex items-center gap-1">
                    <Icon name="calendar" size="xs" />
                    {session.date}
                  </span>
                  <span class="flex items-center gap-1">
                    <Icon name="chart" size="xs" />
                    {session.time}
                  </span>
                  <span class="flex items-center gap-1">
                    <Icon name="location" size="xs" />
                    {session.location}
                  </span>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

      <!-- Special Note about Museum Opening -->
      {ablauf.hinweis && (
        <div class="mt-8 bg-evolea-purple/5 rounded-evolea-lg p-6">
          <div class="flex items-start gap-4">
            <div class="flex-shrink-0">
              <Icon name="heart" size="lg" />
            </div>
            <div>
              <h4 class="font-display font-bold text-evolea-purple mb-2">{getText(ablauf.hinweis.titel, 'Eröffnungsfeier im Kemptpark')}</h4>
              <p class="text-evolea-text-light mb-0">
                {getText(ablauf.hinweis.text, '')}
              </p>
            </div>
          </div>
        </div>
      )}
    </div>
  </section>

  <!-- Project Goals -->
  <section class="py-16 bg-white">
    <div class="container mx-auto max-w-4xl px-4">
      <h2 class="text-3xl font-display font-bold text-evolea-purple mb-8 text-center">
        {getText(ziele.titel, 'Projekt Ziele')}
      </h2>
      <p class="text-lg text-evolea-text-light text-center mb-12 max-w-2xl mx-auto">
        {getText(ziele.untertitel, 'Kinder erleben bei uns, wie sie im Miteinander stark sein können – Schritt für Schritt, mit Freude und Erfolg.')}
      </p>

      <div class="space-y-6">
        {(ziele.liste || []).map((ziel: any) => (
          <div class="bg-evolea-cream/50 rounded-evolea-lg p-6">
            <h3 class="font-display font-bold text-evolea-purple mb-2">{getText(ziel.titel, '')}</h3>
            <p class="text-evolea-text-light mb-0">{getText(ziel.text, '')}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Admission Criteria -->
  <section class="py-16 bg-evolea-cream/30">
    <div class="container mx-auto max-w-4xl px-4">
      <h2 class="text-3xl font-display font-bold text-evolea-purple mb-8 text-center">
        {getText(aufnahme.titel, 'Aufnahmekriterien')}
      </h2>

      <div class="bg-white rounded-evolea-lg p-8 shadow-soft">
        <p class="text-evolea-text-light mb-6">
          {getText(aufnahme.einleitung, 'Die Teilnahme an einem Mini Projekt erfolgt jeweils projektbezogen und beginnt mit einem persönlichen Gespräch mit den Bezugspersonen, sowie einem Kennenlernen des Kindes. Zur Orientierung stellen wir eine Checkliste zur Verfügung:')}
        </p>
        <ul class="space-y-3 mb-6">
          {(aufnahme.kriterien || []).map((kriterium: any) => (
            <li class="flex items-start gap-3">
              <span class="flex-shrink-0 w-6 h-6 bg-evolea-mint/20 rounded-full flex items-center justify-center text-evolea-mint font-bold text-sm">✓</span>
              <span class="text-evolea-text-light">
                <strong class="text-evolea-purple">{getText(kriterium.titel, '')}</strong>
                {getText(kriterium.text, '') && ` - ${getText(kriterium.text, '')}`}
              </span>
            </li>
          ))}
        </ul>
        <p class="text-sm text-evolea-text-light bg-evolea-purple/5 rounded-evolea p-4 mb-0">
          {getText(aufnahme.hinweis, 'Diese Punkte dienen als Richtlinie und ersetzen keine individuelle Beurteilung. Die endgültige Entscheidung wird stets situationsbezogen und im Sinne des Kindes getroffen.')}
        </p>
      </div>
    </div>
  </section>

  <!-- Practical Info -->
  <section class="py-16 md:py-24" id="anmeldung">
    <div class="container mx-auto max-w-4xl px-4">
      <h2 class="text-3xl font-display font-bold text-evolea-purple mb-8 text-center">
        {getText(praktischeInfos.titel, 'Praktische Informationen')}
      </h2>

      <div class="grid md:grid-cols-2 gap-6 mb-12">
        <div class="bg-evolea-cream rounded-evolea-lg p-6">
          <div class="flex items-start gap-4">
            <Icon name="location" size="md" />
            <div>
              <h4 class="font-display font-bold text-evolea-purple mb-2">{lang === 'de' ? 'Standorte' : 'Locations'}</h4>
              {praktischeInfos.standorte?.hauptstandort && (
                <p class="text-evolea-text-light text-sm mb-2">
                  <strong>{getText(praktischeInfos.standorte.hauptstandort.label, 'Tag 1-5:')}</strong><br/>
                  <span set:html={getText(praktischeInfos.standorte.hauptstandort.adresse, '').replace(/\n/g, '<br/>')} />
                </p>
              )}
              {praktischeInfos.standorte?.eroeffnung && (
                <p class="text-evolea-text-light text-sm mb-0">
                  <strong>{getText(praktischeInfos.standorte.eroeffnung.label, 'Tag 6 (Eröffnungsfeier):')}</strong><br/>
                  <span set:html={getText(praktischeInfos.standorte.eroeffnung.adresse, '').replace(/\n/g, '<br/>')} />
                </p>
              )}
            </div>
          </div>
        </div>
        <div class="bg-evolea-cream rounded-evolea-lg p-6">
          <div class="flex items-start gap-4">
            <Icon name="mail" size="md" />
            <div>
              <h4 class="font-display font-bold text-evolea-purple mb-2">{getText(praktischeInfos.kontakt?.titel, 'Kontakt & Anmeldung')}</h4>
              <p class="text-evolea-text-light text-sm mb-2">
                {getText(praktischeInfos.kontakt?.text, 'Für ein kostenloses Erstgespräch und Anmeldung:')}
              </p>
              <a href={`mailto:${praktischeInfos.kontakt?.email || 'hello@evolea.ch'}`} class="text-evolea-magenta hover:text-evolea-purple transition-colors font-semibold">
                {praktischeInfos.kontakt?.email || 'hello@evolea.ch'}
              </a>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-evolea-purple/5 rounded-evolea-lg p-6 text-center">
        <p class="text-evolea-text-light mb-4" set:html={getText(praktischeInfos.wichtig, '<strong class="text-evolea-purple">Wichtig:</strong> Wir treffen uns jeweils um <strong>09:00 Uhr</strong>. Bitte seid 5 Minuten vor Beginn vor Ort. Tag 6 beginnt um <strong>13:00 Uhr</strong> und findet mit Begleitung der Eltern statt.')} />
      </div>
    </div>
  </section>

  <!-- Back to Mini Projekte -->
  <section class="py-8 border-t border-evolea-purple/10">
    <div class="container mx-auto max-w-4xl px-4">
      <a href={translatePath('/angebote/mini-projekte/')} class="text-evolea-purple hover:text-evolea-purple-light transition-colors flex items-center gap-2">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16l-4-4m0 0l4-4m-4 4h18" />
        </svg>
        {lang === 'de' ? 'Zurück zu Mini Projekte' : 'Back to Mini Projects'}
      </a>
    </div>
  </section>

  <EditLink type="singleton" collection="miniMuseum" label={lang === 'de' ? 'Mini Museum bearbeiten' : 'Edit Mini Museum'} />
</Base>
