---
import Base from '@layouts/Base.astro';
import InnerPageHero from '@components/InnerPageHero.astro';
import Icon from '@components/Icon.astro';
import { getLangFromUrl, useTranslations, useTranslatedPath } from '@i18n/utils';
import { getEntry } from 'astro:content';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
const base = import.meta.env.BASE_URL.replace(/\/$/, '');

// Get CMS content
const pageEntry = await getEntry('pages', 'angebote-index');
const page = pageEntry?.data;

// Hero image
const heroImage = base + '/images/hero/angebote-hero.png';

// Helper to get bilingual text
const getText = (obj: { de?: string; en?: string } | undefined, fallback: string = '') => {
  if (!obj) return fallback;
  return lang === 'de' ? (obj.de || fallback) : (obj.en || obj.de || fallback);
};

// Main programs from CMS or fallback
const mainPrograms = page?.hauptProgramme || [
  {
    titel: 'Mini Garten',
    beschreibung: { de: 'Spielerische Vorbereitung auf den Kindergarten in einer kleinen, geschützten Gruppe.', en: 'Playful kindergarten preparation in a small, protected group.' },
    icon: 'sprout',
    farbe: 'green',
    alter: { de: '3-5', en: '3-5' },
    link: '/angebote/mini-garten/',
    status: { de: 'Anmeldung offen', en: 'Registration open' },
  },
  {
    titel: 'Mini Projekte',
    beschreibung: { de: 'Soziale Kompetenz durch kreative Projekte in kleinen Gruppen.', en: 'Social skills through creative projects in small groups.' },
    icon: 'palette',
    farbe: 'orange',
    alter: { de: '5-8', en: '5-8' },
    link: '/angebote/mini-projekte/',
    status: { de: 'Anmeldung offen', en: 'Registration open' },
  },
  {
    titel: 'Mini Turnen',
    beschreibung: { de: 'Bewegung, Spass und motorische Förderung in einer kleinen, verständnisvollen Gruppe.', en: 'Movement, fun and motor skill development in a small, understanding group.' },
    icon: 'ball',
    farbe: 'sky',
    alter: { de: '5-8', en: '5-8' },
    link: '/angebote/mini-turnen/',
    status: { de: 'Anmeldung offen', en: 'Registration open' },
  },
];

// Additional programs from CMS or fallback
const additionalPrograms = page?.weitereProgramme || [
  {
    titel: 'EVOLEA Cafe',
    beschreibung: { de: 'Austausch und Gemeinschaft für Eltern. Jeden 2. Mittwoch im Monat.', en: 'Exchange and community for parents. Every 2nd Wednesday of the month.' },
    icon: 'coffee',
    farbe: 'coral',
    alter: { de: 'Eltern', en: 'Parents' },
    link: '/angebote/evolea-cafe/',
    status: { de: 'Offen für alle', en: 'Open to all' },
    istVision: false,
  },
  {
    titel: 'Tagesschule',
    beschreibung: { de: 'Sonderschule Typ A für Kinder im Spektrum. Wir arbeiten noch daran.', en: "Special school Type A for children on the spectrum. We're still working on it." },
    icon: 'school',
    farbe: 'purple',
    alter: { de: '4-12', en: '4-12' },
    link: '/angebote/tagesschule/',
    status: { de: 'Vision', en: 'Vision' },
    istVision: true,
  },
];

// Labels
const labels = page?.labels || {};
const mehrErfahren = getText(labels.mehrErfahren, 'Mehr erfahren');
const jahreLabel = getText(labels.jahre, 'Jahre');
---

<Base title={getText(page?.hero?.titel, 'Angebote')} description="EVOLEA bietet verschiedene Förderprogramme für Kinder im Autismus Spektrum oder mit ADHS an: Mini Garten, Mini Projekte, Mini Turnen, Tagesschule und mehr." transparentHeader={true}>
  <!-- Premium Hero with Prism Gradient and Image -->
  <InnerPageHero
    title={getText(page?.hero?.titel, t('nav.programs'))}
    subtitle={getText(page?.hero?.untertitel, 'Programme, die jedes Kind dort abholen, wo es steht.')}
    breadcrumbs={[
      { label: lang === 'de' ? 'Startseite' : 'Home', href: translatePath('/') },
      { label: getText(page?.hero?.titel, 'Angebote') }
    ]}
    size="md"
    heroImage={heroImage}
    heroImageAlt={lang === 'de' ? 'Kinder bei EVOLEA Programmen' : 'Children at EVOLEA programs'}
  />

  <!-- Introduction -->
  <section class="py-12 bg-evolea-cream/30">
    <div class="container mx-auto max-w-4xl px-4 text-center">
      <h2 class="text-2xl font-display font-bold text-evolea-purple mb-4">{getText(page?.intro?.titel, 'Unser Ansatz')}</h2>
      <p class="text-lg text-evolea-text-light leading-relaxed">
        {getText(page?.intro?.text, 'Wir bestärken Erfolge und motivieren die Kinder, neue Herausforderungen anzunehmen. Wir setzen auf wissenschaftlich fundierte Methoden, die nachweislich wirksam sind. In kleinen Gruppen mit hohem Betreuungsschlüssel schaffen wir einen geschützten Rahmen für individuelle Entwicklung.')}
      </p>
    </div>
  </section>

  <!-- Main Programs Section -->
  <section class="py-16 md:py-24">
    <div class="container mx-auto max-w-6xl px-4">
      <!-- Aktuelle Angebote Header -->
      <div class="text-center mb-12">
        <span class="inline-block bg-evolea-magenta/10 text-evolea-magenta px-4 py-2 rounded-full text-sm font-semibold mb-4">
          {getText(page?.aktuelleAngebote?.label, 'Aktuelle Angebote')}
        </span>
        <h2 class="text-3xl font-display font-bold text-evolea-purple">
          {getText(page?.aktuelleAngebote?.titel, 'Jetzt anmelden')}
        </h2>
      </div>

      <!-- Main Programs Grid - Purple Gradient Cards -->
      <div class="grid md:grid-cols-3 gap-6 mb-16">
        {mainPrograms.map((program: any) => (
          <a
            href={translatePath(program.link)}
            class="group block rounded-evolea-lg overflow-hidden transition-all hover:shadow-card bg-gradient-to-br from-evolea-magenta to-evolea-purple text-white"
          >
            <div class="p-6">
              <div class="flex items-center justify-between mb-4">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                  <Icon name={program.icon || 'sparkle'} size="lg" gradient={false} />
                </div>
                <span class="text-sm font-medium px-3 py-1 rounded-full bg-white/20">
                  {getText(program.alter, '5-8')} {jahreLabel}
                </span>
              </div>
              <div class="mb-2">
                <span class="inline-flex items-center gap-1 text-xs font-semibold bg-white/30 px-2 py-1 rounded-full">
                  <Icon name="sparkle" size="xs" gradient={false} />
                  {getText(program.status, 'Anmeldung offen')}
                </span>
              </div>
              <h3 class="text-xl font-display font-bold mb-2 group-hover:underline">
                {program.titel}
              </h3>
              <p class="text-sm text-white/90 mb-4">
                {getText(program.beschreibung, '')}
              </p>
              <div class="flex items-center gap-2 text-sm font-medium">
                {mehrErfahren}
                <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </a>
        ))}
      </div>

      <!-- Weitere Angebote Divider -->
      <div class="flex items-center gap-4 mb-8">
        <div class="flex-1 h-px bg-evolea-purple/20"></div>
        <span class="text-sm font-semibold text-evolea-text-light uppercase tracking-wider">{getText(page?.weitereAngeboteLabel, 'Weitere Angebote')}</span>
        <div class="flex-1 h-px bg-evolea-purple/20"></div>
      </div>

      <!-- Additional Programs Grid -->
      <div class="grid md:grid-cols-2 gap-6">
        {additionalPrograms.map((program: any) => (
          <a
            href={translatePath(program.link)}
            class:list={[
              'group block rounded-evolea-lg overflow-hidden transition-all hover:shadow-card',
              program.istVision ? 'bg-evolea-purple/5 border-2 border-dashed border-evolea-purple/30' : 'bg-white border border-evolea-purple/10',
            ]}
          >
            <div class="p-6">
              <div class="flex items-center justify-between mb-4">
                <Icon name={program.icon || 'sparkle'} size="lg" />
                <span class:list={[
                  'text-sm font-medium px-3 py-1 rounded-full',
                  program.istVision ? 'bg-evolea-purple/10 text-evolea-purple' : 'bg-evolea-coral/10 text-evolea-coral',
                ]}>
                  {getText(program.status, '')}
                </span>
              </div>
              <h3 class="text-xl font-display font-bold text-evolea-purple mb-2 group-hover:underline">
                {program.titel}
              </h3>
              <p class="text-sm text-evolea-text-light mb-4">
                {getText(program.beschreibung, '')}
              </p>
              <div class="flex items-center gap-2 text-sm font-medium text-evolea-purple">
                {mehrErfahren}
                <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </div>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

</Base>
