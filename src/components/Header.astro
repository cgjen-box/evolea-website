---
import { getLangFromUrl, useTranslations, useTranslatedPath } from '@i18n/utils';
import LanguagePicker from './LanguagePicker.astro';
import Butterfly from './Butterfly.astro';

interface Props {
  transparent?: boolean;
  siteSettings?: {
    navigation?: {
      de?: {
        home?: string;
        programs?: string;
        about?: string;
        team?: string;
        blog?: string;
        contact?: string;
      };
      en?: {
        home?: string;
        programs?: string;
        about?: string;
        team?: string;
        blog?: string;
        contact?: string;
      };
    };
  };
}

const { transparent = false, siteSettings } = Astro.props;

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);

const navLabels = siteSettings?.navigation?.[lang] || {};
const navLabelMap: Record<string, string | undefined> = {
  'nav.programs': navLabels.programs,
  'nav.about': navLabels.about,
  'nav.team': navLabels.team,
  'nav.blog': navLabels.blog,
  'nav.contact': navLabels.contact,
};

const navItems = [
  { key: 'nav.programs', href: '/angebote/' },
  { key: 'nav.about', href: '/ueber-uns/' },
  { key: 'nav.team', href: '/team/' },
  { key: 'nav.blog', href: '/blog/' },
  { key: 'nav.contact', href: '/kontakt/' },
] as const;

// Get donate path based on language
const donatePath = lang === 'de' ? '/spenden/' : '/donate/';
---

<!-- Navbar Wrapper - Contains both navbar and fade effect -->
<div id="navbar-wrapper" class="navbar-wrapper">
  <!-- Desktop Header -->
  <header
    id="main-header"
    class:list={[
      'main-header',
      transparent ? 'header-transparent' : '',
    ]}
    data-transparent={transparent}
  >
    <!-- Prism Gradient Background (only visible when scrolled) -->
    <div class="header-prism-bg" aria-hidden="true">
      <div class="header-prism-gradient"></div>
      <div class="header-glass-layer"></div>

      <!-- Floating Orbs -->
      <div class="header-orbs">
        <div class="header-orb header-orb-mint"></div>
        <div class="header-orb header-orb-gold"></div>
        <div class="header-orb header-orb-pink"></div>
        <div class="header-orb header-orb-purple"></div>
      </div>

      <!-- Floating Butterflies -->
      <div class="header-butterflies">
        <div class="header-butterfly header-butterfly-1">
          <Butterfly size="sm" variant="white" />
        </div>
        <div class="header-butterfly header-butterfly-2">
          <Butterfly size="sm" variant="spectrum" />
        </div>
        <div class="header-butterfly header-butterfly-3">
          <Butterfly size="sm" variant="white" />
        </div>
      </div>
    </div>

    <nav class="header-nav container mx-auto px-4 py-4 flex items-center justify-between">
      <!-- Logo -->
      <a
        href={translatePath('/')}
        class:list={[
          'logo-link flex items-center gap-2 font-display font-bold text-xl transition-colors',
          transparent ? 'text-white' : 'text-evolea-purple',
        ]}
      >
        <span class="logo-text">EVOLEA</span>
        <span class="logo-butterfly">
          <Butterfly size="sm" variant={transparent ? 'white' : 'spectrum'} />
        </span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-6">
        {navItems.map(({ key, href }) => {
          const isActive = Astro.url.pathname.startsWith(translatePath(href));
          return (
            <a
              href={translatePath(href)}
              class:list={[
                'nav-link relative font-medium transition-colors py-2',
                transparent ? 'text-white/90 hover:text-white' : 'text-evolea-text hover:text-evolea-magenta',
                isActive && !transparent && 'nav-link-active text-evolea-magenta',
                isActive && transparent && 'nav-link-active-light',
              ]}
            >
              {navLabelMap[key] || t(key)}
            </a>
          );
        })}
        <LanguagePicker />
        <a
          href={translatePath(donatePath)}
          class="nav-donate"
        >
          {t('nav.donate')}
        </a>
      </div>

      <!-- Mobile Menu Button -->
      <button
        type="button"
        id="mobile-menu-btn"
        class:list={[
          'md:hidden p-3 min-h-[44px] min-w-[44px] flex items-center justify-center rounded-lg transition-colors',
          transparent ? 'text-white hover:bg-white/10' : 'text-evolea-purple hover:bg-evolea-purple/10',
        ]}
        aria-expanded="false"
        aria-label={lang === 'de' ? 'Menü öffnen' : 'Open menu'}
      >
        <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </nav>
  </header>

  <!-- The Wave Fade Effect (positioned below header) -->
  <div class="navbar-fade" aria-hidden="true">
    <!-- Soft Blur Mist -->
    <div class="navbar-fade__mist"></div>

    <!-- Wave Layers -->
    <div class="navbar-fade__wave navbar-fade__wave--primary"></div>
    <div class="navbar-fade__wave navbar-fade__wave--secondary"></div>
    <div class="navbar-fade__wave navbar-fade__wave--tertiary"></div>

    <!-- Prismatic Shimmer -->
    <div class="navbar-fade__shimmer"></div>

    <!-- Bottom Feather -->
    <div class="navbar-fade__feather"></div>
  </div>
</div>

<!-- Mobile Menu Overlay -->
<div
  id="mobile-menu-overlay"
  class="mobile-menu-overlay"
  aria-hidden="true"
>
  <div class="mobile-menu-bg"></div>

  <div class="mobile-menu-content">
    <button
      type="button"
      id="mobile-menu-close"
      class="absolute top-6 right-6 p-3 rounded-full bg-white/20 text-white hover:bg-white/30 transition-colors z-10"
      aria-label={lang === 'de' ? 'Menü schließen' : 'Close menu'}
    >
      <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <a href={translatePath('/')} class="flex items-center gap-3 mb-12">
      <span class="font-display font-bold text-3xl text-white">EVOLEA</span>
      <Butterfly size="md" variant="white" />
    </a>

    <nav class="flex flex-col gap-2 mb-auto">
      {navItems.map(({ key, href }, index) => (
        <a
          href={translatePath(href)}
          class="mobile-nav-link py-4 text-2xl sm:text-3xl font-display font-bold text-white/90 hover:text-white transition-colors"
          style={`animation-delay: ${index * 0.05}s`}
        >
          {navLabelMap[key] || t(key)}
        </a>
      ))}
    </nav>

    <div class="mt-auto pt-8">
      <a
        href={translatePath(donatePath)}
        class="mobile-donate flex items-center justify-center gap-2.5 w-full py-4 px-6 font-display font-bold text-lg rounded-full shadow-xl hover:shadow-2xl transition-all mb-6"
      >
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
        {t('nav.donate')}
      </a>
      <div class="flex items-center justify-center gap-3 text-white/60 text-sm">
        <span>{lang === 'de' ? 'Sprache' : 'Language'}</span>
        <LanguagePicker />
      </div>
    </div>
  </div>
</div>

<style is:global>
  /* ===========================================
     NAVBAR WRAPPER - Contains header + fade
     =========================================== */
  .navbar-wrapper {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 50;
    /* Hidden by default - only shows on scroll up */
    transform: translateY(-100%);
    opacity: 0;
    /* Slower hide (0.5s), faster show (0.35s) for better feel */
    transition:
      transform 0.5s cubic-bezier(0.4, 0, 0.2, 1),
      opacity 0.4s ease;
    pointer-events: none;
  }

  .navbar-wrapper.visible {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
    /* Faster appear transition */
    transition:
      transform 0.35s cubic-bezier(0.0, 0, 0.2, 1),
      opacity 0.25s ease;
  }

  /* At top of page - show header without prism effect */
  .navbar-wrapper.at-top {
    transform: translateY(0);
    opacity: 1;
    pointer-events: auto;
  }

  .navbar-wrapper.at-top .header-prism-bg,
  .navbar-wrapper.at-top .navbar-fade {
    opacity: 0;
    pointer-events: none;
  }

  /* ===========================================
     MAIN HEADER
     =========================================== */
  .main-header {
    position: relative;
    background: rgba(255, 251, 247, 0.95);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }

  .main-header.header-transparent {
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }

  /* When scrolled and visible - use prism bg */
  .navbar-wrapper.visible:not(.at-top) .main-header {
    background: transparent;
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
  }

  /* ===========================================
     PRISM GRADIENT BACKGROUND (visible on scroll)
     =========================================== */
  .header-prism-bg {
    position: absolute;
    inset: 0;
    overflow: hidden;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .navbar-wrapper.visible:not(.at-top) .header-prism-bg {
    opacity: 1;
  }

  .header-prism-gradient {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      135deg,
      #7BEDD5 0%,      /* Mint */
      #FFE066 18%,     /* Sunshine */
      #FF9ECC 36%,     /* Blush pink */
      #E97BF1 54%,     /* Magenta */
      #CD87F8 72%,     /* Lavender */
      #BA53AD 100%     /* Deep purple */
    );
    background-size: 400% 400%;
    animation: prismShift 20s ease infinite;
  }

  @keyframes prismShift {
    0%, 100% { background-position: 0% 50%; }
    25% { background-position: 50% 100%; }
    50% { background-position: 100% 50%; }
    75% { background-position: 50% 0%; }
  }

  .header-glass-layer {
    position: absolute;
    inset: 0;
    background: linear-gradient(
      180deg,
      rgba(255, 255, 255, 0.15) 0%,
      rgba(255, 255, 255, 0.08) 50%,
      rgba(255, 255, 255, 0.03) 100%
    );
    backdrop-filter: blur(8px) saturate(140%);
    -webkit-backdrop-filter: blur(8px) saturate(140%);
  }

  /* ===========================================
     FLOATING ORBS
     =========================================== */
  .header-orbs {
    position: absolute;
    inset: 0;
    overflow: hidden;
    pointer-events: none;
  }

  .header-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(50px);
    opacity: 0.5;
    animation: orbFloat 18s ease-in-out infinite;
    mix-blend-mode: screen;
  }

  .header-orb-mint {
    width: 180px;
    height: 180px;
    background: radial-gradient(circle, #7BEDD5 0%, #4ECDC4 100%);
    top: -40%;
    left: 5%;
  }

  .header-orb-gold {
    width: 150px;
    height: 150px;
    background: radial-gradient(circle, #FFE066 0%, #FFC83D 100%);
    top: -30%;
    left: 35%;
    animation-delay: -5s;
  }

  .header-orb-pink {
    width: 200px;
    height: 200px;
    background: radial-gradient(circle, #FF9ECC 0%, #E97BF1 100%);
    top: -50%;
    right: 10%;
    animation-delay: -10s;
  }

  .header-orb-purple {
    width: 160px;
    height: 160px;
    background: radial-gradient(circle, #CD87F8 0%, #BA53AD 100%);
    top: -35%;
    right: 40%;
    animation-delay: -15s;
  }

  @keyframes orbFloat {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(20px, -10px) scale(1.05); }
    50% { transform: translate(-15px, 15px) scale(0.95); }
    75% { transform: translate(10px, 5px) scale(1.02); }
  }

  /* ===========================================
     FLOATING BUTTERFLIES
     =========================================== */
  .header-butterflies {
    position: absolute;
    inset: 0;
    overflow: visible;
    pointer-events: none;
  }

  .header-butterfly {
    position: absolute;
    animation: butterflyDrift 25s ease-in-out infinite;
    filter: drop-shadow(0 2px 8px rgba(255, 255, 255, 0.4));
  }

  .header-butterfly-1 {
    top: 20%;
    left: 8%;
    opacity: 0.6;
  }

  .header-butterfly-2 {
    top: 35%;
    right: 15%;
    opacity: 0.5;
    animation-delay: -8s;
  }

  .header-butterfly-3 {
    top: 15%;
    right: 45%;
    opacity: 0.45;
    animation-delay: -16s;
  }

  @keyframes butterflyDrift {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    25% { transform: translate(30px, -15px) rotate(8deg); }
    50% { transform: translate(10px, 20px) rotate(-5deg); }
    75% { transform: translate(-20px, -10px) rotate(6deg); }
  }

  /* ===========================================
     NAV CONTENT
     =========================================== */
  .header-nav {
    position: relative;
    z-index: 10;
  }

  /* Text styles when scrolled */
  .navbar-wrapper.visible:not(.at-top) .logo-text {
    background: white !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
  }

  .navbar-wrapper.visible:not(.at-top) .nav-link {
    color: rgba(255, 255, 255, 0.95) !important;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
  }

  .navbar-wrapper.visible:not(.at-top) .nav-link:hover {
    color: #FFFFFF !important;
  }

  .navbar-wrapper.visible:not(.at-top) .nav-link-active::after,
  .navbar-wrapper.visible:not(.at-top) .nav-link-active-light::after {
    background: white !important;
  }

  .navbar-wrapper.visible:not(.at-top) #mobile-menu-btn {
    color: white !important;
  }

  .navbar-wrapper.visible:not(.at-top) #mobile-menu-btn:hover {
    background: rgba(255, 255, 255, 0.15) !important;
  }

  /* Gold donate button - enhanced glow when scrolled */
  .navbar-wrapper.visible:not(.at-top) .nav-donate {
    box-shadow:
      0 4px 20px rgba(232, 184, 109, 0.5),
      0 0 35px rgba(255, 224, 102, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.5);
  }

  /* iOS Safari requires webkit prefix */
  @-webkit-keyframes goldShimmer {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  @keyframes goldShimmer {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  /* ===========================================
     NAVBAR FADE - "Butterfly's Edge"
     =========================================== */
  .navbar-fade {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    height: 120px;
    pointer-events: none;
    overflow: visible;
    opacity: 0;
    transition: opacity 0.4s ease;
  }

  .navbar-wrapper.visible:not(.at-top) .navbar-fade {
    opacity: 1;
  }

  /* ===========================================
     SOFT BLUR MIST
     =========================================== */
  .navbar-fade__mist {
    position: absolute;
    top: -30px;
    left: 0;
    right: 0;
    height: 80px;
    background: linear-gradient(
      180deg,
      rgba(205, 135, 248, 0.6) 0%,    /* Lavender */
      rgba(205, 135, 248, 0.3) 40%,
      rgba(205, 135, 248, 0) 100%
    );
    filter: blur(25px);
  }

  /* ===========================================
     WAVE LAYERS
     =========================================== */
  .navbar-fade__wave {
    position: absolute;
    top: 0;
    left: 0;
    width: 200%;
    height: 100%;
    will-change: transform;
  }

  /* Primary Wave - Deep purple to lavender */
  .navbar-fade__wave--primary {
    background: linear-gradient(
      180deg,
      rgba(186, 83, 173, 0.9) 0%,      /* Deep purple */
      rgba(205, 135, 248, 0.7) 20%,    /* Lavender */
      rgba(205, 135, 248, 0.4) 45%,
      rgba(205, 135, 248, 0.15) 70%,
      transparent 100%
    );
    clip-path: polygon(
      0% 0%,
      0% 25%,
      5% 35%,
      10% 30%,
      15% 40%,
      20% 45%,
      25% 38%,
      30% 50%,
      35% 55%,
      40% 48%,
      45% 60%,
      50% 52%,
      55% 45%,
      60% 55%,
      65% 62%,
      70% 50%,
      75% 58%,
      80% 45%,
      85% 55%,
      90% 48%,
      95% 40%,
      100% 35%,
      100% 0%
    );
    animation: waveDriftSlow 25s ease-in-out infinite;
  }

  /* Secondary Wave - Pink/magenta */
  .navbar-fade__wave--secondary {
    background: linear-gradient(
      180deg,
      rgba(233, 123, 241, 0.6) 0%,     /* Magenta */
      rgba(255, 158, 204, 0.4) 25%,    /* Blush */
      rgba(255, 158, 204, 0.2) 50%,
      rgba(255, 158, 204, 0.05) 75%,
      transparent 100%
    );
    clip-path: polygon(
      0% 0%,
      0% 15%,
      8% 22%,
      12% 18%,
      18% 28%,
      25% 20%,
      32% 30%,
      38% 25%,
      45% 35%,
      52% 28%,
      58% 38%,
      65% 32%,
      72% 25%,
      78% 35%,
      85% 28%,
      92% 22%,
      100% 18%,
      100% 0%
    );
    animation: waveDriftMedium 18s ease-in-out infinite reverse;
  }

  /* Tertiary Wave - Mint/gold sparkle */
  .navbar-fade__wave--tertiary {
    background: linear-gradient(
      180deg,
      rgba(123, 237, 213, 0.4) 0%,     /* Mint */
      rgba(255, 224, 102, 0.25) 30%,   /* Gold */
      rgba(255, 224, 102, 0.1) 60%,
      transparent 100%
    );
    clip-path: polygon(
      0% 0%,
      0% 10%,
      6% 15%,
      12% 12%,
      18% 18%,
      24% 14%,
      30% 20%,
      36% 16%,
      42% 22%,
      48% 18%,
      54% 24%,
      60% 20%,
      66% 15%,
      72% 22%,
      78% 17%,
      84% 12%,
      90% 18%,
      96% 14%,
      100% 10%,
      100% 0%
    );
    animation: waveDriftFast 12s ease-in-out infinite;
  }

  @keyframes waveDriftSlow {
    0%, 100% { transform: translateX(0) scaleY(1); }
    25% { transform: translateX(-12%) scaleY(1.05); }
    50% { transform: translateX(-25%) scaleY(0.95); }
    75% { transform: translateX(-12%) scaleY(1.02); }
  }

  @keyframes waveDriftMedium {
    0%, 100% { transform: translateX(0) scaleY(1); }
    33% { transform: translateX(-16%) scaleY(1.08); }
    66% { transform: translateX(-33%) scaleY(0.92); }
  }

  @keyframes waveDriftFast {
    0%, 100% { transform: translateX(0); }
    50% { transform: translateX(-25%); }
  }

  /* ===========================================
     PRISMATIC SHIMMER
     =========================================== */
  .navbar-fade__shimmer {
    position: absolute;
    top: 0;
    left: -100%;
    width: 50%;
    height: 80%;
    background: linear-gradient(
      90deg,
      transparent 0%,
      rgba(255, 255, 255, 0.15) 30%,
      rgba(255, 255, 255, 0.25) 50%,
      rgba(255, 255, 255, 0.15) 70%,
      transparent 100%
    );
    animation: shimmerSweep 10s ease-in-out infinite;
    pointer-events: none;
  }

  @keyframes shimmerSweep {
    0% { left: -50%; opacity: 0; }
    10% { opacity: 1; }
    90% { opacity: 1; }
    100% { left: 150%; opacity: 0; }
  }

  /* ===========================================
     BOTTOM FEATHER
     =========================================== */
  .navbar-fade__feather {
    position: absolute;
    bottom: -20px;
    left: 0;
    right: 0;
    height: 40px;
    background: radial-gradient(
      ellipse 80% 100% at 50% 0%,
      rgba(205, 135, 248, 0.15) 0%,
      transparent 70%
    );
    filter: blur(15px);
  }
</style>

<style>
  /* ===========================================
     SCOPED STYLES
     =========================================== */

  /* Logo gradient text */
  .logo-text {
    background: linear-gradient(90deg, #7BEDD5 0%, #FFE066 25%, #FF7E5D 50%, #E97BF1 75%, #CD87F8 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .header-transparent .logo-text {
    background: white;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  /* Nav link with spectrum underline on active */
  .nav-link-active::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    height: 3px;
    background: linear-gradient(90deg, #7BEDD5, #FFE066, #FF7E5D, #E97BF1, #CD87F8);
    border-radius: 2px;
  }

  .nav-link-active-light::after {
    content: '';
    position: absolute;
    bottom: -4px;
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    height: 3px;
    background: white;
    border-radius: 2px;
  }

  /* Donate button */
  .nav-donate {
    background: linear-gradient(
      135deg,
      #E8B86D 0%,
      #FFE066 25%,
      #F5D54A 50%,
      #E8B86D 75%,
      #D4A056 100%
    );
    background-size: 200% 200%;
    animation: goldShimmer 4s ease infinite;
    color: #FFFFFF;
    padding: 0.6rem 1.25rem;
    border-radius: 100px;
    font-weight: 700;
    font-size: 0.9rem;
    text-shadow:
      0 1px 1px rgba(0, 0, 0, 0.35),
      0 2px 5px rgba(0, 0, 0, 0.3),
      0 4px 12px rgba(138, 61, 158, 0.6),
      0 0 30px rgba(0, 0, 0, 0.2);
    box-shadow:
      0 4px 15px rgba(232, 184, 109, 0.4),
      0 0 25px rgba(255, 224, 102, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .nav-donate:hover {
    transform: translateY(-3px) scale(1.02);
    box-shadow:
      0 6px 25px rgba(232, 184, 109, 0.5),
      0 0 40px rgba(255, 224, 102, 0.4),
      inset 0 1px 0 rgba(255, 255, 255, 0.5);
  }

  /* Mobile donate button - enhanced prominence */
  .mobile-donate {
    background: linear-gradient(
      135deg,
      #E8B86D 0%,
      #FFE066 25%,
      #F5D54A 50%,
      #E8B86D 75%,
      #D4A056 100%
    );
    background-size: 200% 200%;
    /* iOS Safari needs webkit prefix */
    -webkit-animation: goldShimmer 4s ease infinite;
    animation: goldShimmer 4s ease infinite;
    color: #FFFFFF;
    text-shadow:
      0 2px 2px rgba(0, 0, 0, 0.4),
      0 3px 8px rgba(0, 0, 0, 0.35),
      0 5px 15px rgba(138, 61, 158, 0.7),
      0 0 40px rgba(0, 0, 0, 0.25);
    box-shadow:
      0 6px 30px rgba(232, 184, 109, 0.5),
      0 0 50px rgba(255, 224, 102, 0.4),
      inset 0 2px 0 rgba(255, 255, 255, 0.5),
      inset 0 -2px 0 rgba(0, 0, 0, 0.15);
    /* Hardware acceleration for iOS */
    -webkit-transform: translateZ(0);
    transform: translateZ(0);
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
  }

  .mobile-donate:active {
    transform: translateY(2px) scale(0.98);
    box-shadow:
      0 3px 15px rgba(232, 184, 109, 0.4),
      0 0 30px rgba(255, 224, 102, 0.3),
      inset 0 1px 0 rgba(255, 255, 255, 0.4);
  }

  /* Hover only on devices that support it */
  @media (hover: hover) and (pointer: fine) {
    .mobile-donate:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow:
        0 8px 40px rgba(232, 184, 109, 0.6),
        0 0 70px rgba(255, 224, 102, 0.5),
        inset 0 2px 0 rgba(255, 255, 255, 0.6);
    }
  }

  /* ===========================================
     MOBILE MENU
     =========================================== */
  .mobile-menu-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100vw;
    height: 100vh;
    height: 100dvh;
    z-index: 999999;
    visibility: hidden;
    opacity: 0;
    pointer-events: none;
    transform: translateX(100%);
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1),
                opacity 0.3s ease,
                visibility 0.3s ease;
  }

  .mobile-menu-overlay.open {
    visibility: visible;
    opacity: 1;
    pointer-events: auto;
    transform: translateX(0);
  }

  /* iOS Safari doesn't animate background-position reliably */
  /* Use transform-based animation instead for iOS compatibility */
  .mobile-menu-bg {
    position: absolute;
    inset: 0;
    overflow: hidden;
    background: #BA53AD; /* Fallback solid color */
  }

  /* Animated gradient using pseudo-elements with transform */
  /* This approach works reliably on iOS Safari */
  .mobile-menu-bg::before,
  .mobile-menu-bg::after {
    content: '';
    position: absolute;
    inset: -50%;
    width: 200%;
    height: 200%;
    background: linear-gradient(
      135deg,
      #BA53AD 0%,
      #DD48E0 20%,
      #CD87F8 40%,
      #7BEDD5 60%,
      #5DADE2 80%,
      #BA53AD 100%
    );
    /* Transform animation works on iOS */
    -webkit-animation: gradientRotate 20s linear infinite;
    animation: gradientRotate 20s linear infinite;
    -webkit-transform-origin: center center;
    transform-origin: center center;
  }

  .mobile-menu-bg::after {
    background: linear-gradient(
      225deg,
      #5DADE2 0%,
      #7BEDD5 20%,
      #CD87F8 40%,
      #DD48E0 60%,
      #BA53AD 80%,
      #5DADE2 100%
    );
    -webkit-animation-delay: -10s;
    animation-delay: -10s;
    -webkit-animation-duration: 25s;
    animation-duration: 25s;
    opacity: 0.8;
  }

  /* Transform-based animation - iOS compatible */
  @-webkit-keyframes gradientRotate {
    0% {
      -webkit-transform: translate(0, 0) rotate(0deg) scale(1);
      transform: translate(0, 0) rotate(0deg) scale(1);
    }
    33% {
      -webkit-transform: translate(-10%, 10%) rotate(120deg) scale(1.1);
      transform: translate(-10%, 10%) rotate(120deg) scale(1.1);
    }
    66% {
      -webkit-transform: translate(10%, -5%) rotate(240deg) scale(1.05);
      transform: translate(10%, -5%) rotate(240deg) scale(1.05);
    }
    100% {
      -webkit-transform: translate(0, 0) rotate(360deg) scale(1);
      transform: translate(0, 0) rotate(360deg) scale(1);
    }
  }

  @keyframes gradientRotate {
    0% {
      transform: translate(0, 0) rotate(0deg) scale(1);
    }
    33% {
      transform: translate(-10%, 10%) rotate(120deg) scale(1.1);
    }
    66% {
      transform: translate(10%, -5%) rotate(240deg) scale(1.05);
    }
    100% {
      transform: translate(0, 0) rotate(360deg) scale(1);
    }
  }

  .mobile-menu-content {
    position: relative;
    z-index: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    padding: 6rem 2rem 2rem;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .mobile-nav-link {
    opacity: 0;
    transform: translateX(20px);
    transition: opacity 0.3s ease, transform 0.3s ease, color 0.2s ease;
  }

  .mobile-menu-overlay.open .mobile-nav-link {
    opacity: 1;
    transform: translateX(0);
  }

  :global(body.menu-open) {
    overflow: hidden !important;
    position: fixed !important;
    width: 100% !important;
    height: 100% !important;
    touch-action: none !important;
  }

  /* ===========================================
     REDUCED MOTION
     =========================================== */
  @media (prefers-reduced-motion: reduce) {
    .navbar-wrapper {
      transition: opacity 0.1s ease;
    }

    :global(.header-prism-gradient),
    :global(.header-orb),
    :global(.header-butterfly),
    :global(.navbar-fade__wave),
    :global(.navbar-fade__shimmer),
    :global(.nav-donate),
    :global(.mobile-donate) {
      animation: none !important;
      background-position: 50% 50%;
    }

    .mobile-menu-overlay {
      transition: opacity 0.1s ease, visibility 0.1s ease;
      transform: none !important;
    }

    .mobile-menu-bg::before,
    .mobile-menu-bg::after {
      animation: none !important;
      transform: none !important;
    }

    .mobile-nav-link {
      opacity: 1;
      transform: none;
    }
  }
</style>

<script>
  function initNavbar() {
    const wrapper = document.getElementById('navbar-wrapper');
    const menuBtn = document.getElementById('mobile-menu-btn');
    const menuClose = document.getElementById('mobile-menu-close');
    const menuOverlay = document.getElementById('mobile-menu-overlay');

    if (!wrapper) return;

    let lastScrollY = window.scrollY;
    let ticking = false;
    let hasScrolledDown = false;

    // Scroll thresholds for smoother behavior
    // Mobile needs higher thresholds to avoid accidental hiding during touch scrolling
    const isMobile = window.innerWidth < 768;
    const SHOW_THRESHOLD = isMobile ? 80 : 60;   // Pixels of upward scroll needed to show navbar
    const HIDE_THRESHOLD = isMobile ? 100 : 30;  // Pixels of downward scroll needed to hide navbar (much higher on mobile)
    const TOP_ZONE = 80;        // Pixels from top where navbar always shows

    // Track cumulative scroll distance in current direction
    let scrollDelta = 0;
    let lastDirection: 'up' | 'down' | null = null;

    const updateNavbar = () => {
      const currentScrollY = window.scrollY;
      const scrollDiff = currentScrollY - lastScrollY;

      // Don't update when mobile menu is open
      if (document.body.classList.contains('menu-open')) {
        ticking = false;
        return;
      }

      // At top of page - always show without prism effect
      if (currentScrollY <= TOP_ZONE) {
        wrapper.classList.add('at-top');
        wrapper.classList.add('visible');
        wrapper.classList.remove('hidden');
        hasScrolledDown = false;
        scrollDelta = 0;
        lastDirection = null;
        lastScrollY = currentScrollY;
        ticking = false;
        return;
      }

      // Determine scroll direction
      const currentDirection: 'up' | 'down' = scrollDiff > 0 ? 'down' : 'up';

      // Reset delta if direction changed
      if (currentDirection !== lastDirection) {
        scrollDelta = 0;
        lastDirection = currentDirection;
      }

      // Accumulate scroll distance
      scrollDelta += Math.abs(scrollDiff);

      // Scrolling down - hide after threshold
      if (currentDirection === 'down' && scrollDelta >= HIDE_THRESHOLD) {
        hasScrolledDown = true;
        wrapper.classList.remove('visible');
        wrapper.classList.remove('at-top');
        wrapper.classList.add('hidden');
      }
      // Scrolling up - show after threshold (only if we've scrolled down first)
      else if (currentDirection === 'up' && scrollDelta >= SHOW_THRESHOLD && hasScrolledDown) {
        wrapper.classList.add('visible');
        wrapper.classList.remove('at-top');
        wrapper.classList.remove('hidden');
      }

      lastScrollY = currentScrollY;
      ticking = false;
    };

    // Initial state
    if (window.scrollY <= TOP_ZONE) {
      wrapper.classList.add('at-top');
      wrapper.classList.add('visible');
    }

    window.addEventListener('scroll', () => {
      if (!ticking) {
        window.requestAnimationFrame(updateNavbar);
        ticking = true;
      }
    }, { passive: true });

    // Mobile menu handlers
    if (menuBtn && menuOverlay) {
      const openMenu = () => {
        menuOverlay.classList.add('open');
        menuOverlay.setAttribute('aria-hidden', 'false');
        menuBtn.setAttribute('aria-expanded', 'true');
        document.body.classList.add('menu-open');
      };

      const closeMenu = () => {
        menuOverlay.classList.remove('open');
        menuOverlay.setAttribute('aria-hidden', 'true');
        menuBtn.setAttribute('aria-expanded', 'false');
        document.body.classList.remove('menu-open');
      };

      menuBtn.addEventListener('click', openMenu);
      menuClose?.addEventListener('click', closeMenu);

      menuOverlay.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', closeMenu);
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && menuOverlay.classList.contains('open')) {
          closeMenu();
        }
      });

      menuOverlay.addEventListener('click', (e) => {
        if (e.target === menuOverlay) {
          closeMenu();
        }
      });
    }
  }

  document.addEventListener('DOMContentLoaded', initNavbar);
  document.addEventListener('astro:page-load', initNavbar);
</script>
