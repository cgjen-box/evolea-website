---
import { getLangFromUrl } from '@i18n/utils';
import FloatingShapes from './FloatingShapes.astro';

interface Props {
  title: string;
  subtitle: string;
  videoSrc?: string;
  primaryButtonText?: string;
  primaryButtonHref?: string;
  secondaryButtonText?: string;
  secondaryButtonHref?: string;
  showScrollIndicator?: boolean;
}

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const {
  title,
  subtitle,
  videoSrc = `${base}/videos/hero-mobile.mp4`,
  primaryButtonText,
  primaryButtonHref,
  secondaryButtonText,
  secondaryButtonHref,
  showScrollIndicator = true,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
---

<section class="hero-video" aria-label={lang === 'de' ? 'Hauptbereich' : 'Hero section'}>
  <!-- Video Background - iOS Safari optimized: SINGLE video, NO display:none -->
  <!-- Using mobile-optimized video (1.3MB) for all devices - iOS Safari compatible -->
  <video
    class="hero-video-element"
    id="hero-video"
    autoplay
    muted
    loop
    playsinline
    webkit-playsinline
  >
    <source src={videoSrc} type="video/mp4" />
  </video>

  <!-- Overlay gradient -->
  <div class="hero-video-overlay" aria-hidden="true"></div>

  <!-- Floating decorative shapes -->
  <FloatingShapes variant="hero" />

  <!-- Content -->
  <div class="hero-video-content">
    <h1 class="animate-fade-slide-down" style="animation-delay: 0.2s;">
      {title}
    </h1>
    <p class="animate-fade-slide-up" style="animation-delay: 0.4s;">
      {subtitle}
    </p>

    {(primaryButtonText || secondaryButtonText) && (
      <div class="hero-buttons animate-fade-slide-up" style="animation-delay: 0.6s;">
        {primaryButtonText && primaryButtonHref && (
          <a href={primaryButtonHref} class="btn-white btn-mobile-full">
            {primaryButtonText}
          </a>
        )}
        {secondaryButtonText && secondaryButtonHref && (
          <a href={secondaryButtonHref} class="btn-outline-hero btn-mobile-full">
            {secondaryButtonText}
          </a>
        )}
      </div>
    )}
  </div>

  <!-- Scroll indicator -->
  {showScrollIndicator && (
    <div class="scroll-indicator" aria-hidden="true">
      <span class="text-sm font-medium">{lang === 'de' ? 'Entdecken' : 'Explore'}</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
      </svg>
    </div>
  )}
</section>

<style>
  .hero-video {
    min-height: 100vh;
    min-height: 100dvh; /* Dynamic viewport height for mobile */
  }

  /* Video element - matches planted-website approach exactly */
  /* CRITICAL: No display:none anywhere - iOS Safari breaks autoplay with display:none */
  .hero-video-element {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Ensure content stays above video */
  .hero-video-content {
    position: relative;
    z-index: 10;
  }

  /* Animation keyframes for content */
  @keyframes fadeSlideDown {
    0% {
      opacity: 0;
      transform: translateY(-30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeSlideUp {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-slide-down {
    opacity: 0;
    animation: fadeSlideDown 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .animate-fade-slide-up {
    opacity: 0;
    animation: fadeSlideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  /* Reduced motion: disable animations but keep video playing */
  @media (prefers-reduced-motion: reduce) {
    .animate-fade-slide-down,
    .animate-fade-slide-up {
      opacity: 1;
      animation: none;
    }

    .scroll-indicator {
      animation: none;
    }
  }
</style>

<script>
  // AGGRESSIVE iOS Safari video autoplay fix
  // Problem: DOMContentLoaded fires BEFORE video is ready on iOS
  // Solution: Use video-specific events + multiple retry strategies

  function initVideoAutoplay() {
    const video = document.getElementById('hero-video') as HTMLVideoElement;
    if (!video) return;

    // Critical: ensure muted attribute is set (required for iOS autoplay)
    video.muted = true;
    video.setAttribute('muted', '');
    video.setAttribute('playsinline', '');
    video.setAttribute('webkit-playsinline', '');

    // Attempt to play with retry logic
    function attemptPlay() {
      if (!video.paused) return; // Already playing

      const playPromise = video.play();
      if (playPromise !== undefined) {
        playPromise.catch(() => {
          // Silently fail - will retry
        });
      }
    }

    // Strategy 1: Play when video has enough data
    video.addEventListener('canplaythrough', attemptPlay, { once: true });
    video.addEventListener('loadeddata', attemptPlay, { once: true });
    video.addEventListener('loadedmetadata', attemptPlay, { once: true });

    // Strategy 2: Progressive retry with increasing delays
    // iOS sometimes needs time after DOM is ready
    const delays = [0, 100, 300, 500, 1000, 2000];
    delays.forEach(delay => {
      setTimeout(attemptPlay, delay);
    });

    // Strategy 3: Try to play immediately
    attemptPlay();

    // Strategy 4: Force load if not started
    if (video.readyState < 2) {
      video.load();
    }
  }

  // Run on initial page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initVideoAutoplay);
  } else {
    // DOM already ready
    initVideoAutoplay();
  }

  // Run on Astro page transitions
  document.addEventListener('astro:page-load', initVideoAutoplay);

  // Fallback: also try on window load (all resources loaded)
  window.addEventListener('load', initVideoAutoplay);
</script>
