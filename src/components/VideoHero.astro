---
import { getLangFromUrl } from '@i18n/utils';
import FloatingShapes from './FloatingShapes.astro';

interface Props {
  title: string;
  subtitle: string;
  videoSrc?: string;
  videoSrcMobile?: string;
  posterSrc?: string;
  primaryButtonText?: string;
  primaryButtonHref?: string;
  secondaryButtonText?: string;
  secondaryButtonHref?: string;
  showScrollIndicator?: boolean;
}

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const {
  title,
  subtitle,
  videoSrc = `${base}/videos/hero.mp4`,
  videoSrcMobile = `${base}/videos/hero-mobile.mp4`,
  posterSrc = `${base}/images/hero-poster.jpg`,
  primaryButtonText,
  primaryButtonHref,
  secondaryButtonText,
  secondaryButtonHref,
  showScrollIndicator = true,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
---

<section class="hero-video" aria-label={lang === 'de' ? 'Hauptbereich' : 'Hero section'}>
  <!-- Video Background - iOS Safari optimized with mobile-specific source -->
  <video
    class="hero-video-element"
    autoplay
    muted
    loop
    playsinline
    id="hero-video"
    data-src-desktop={videoSrc}
    data-src-mobile={videoSrcMobile}
  >
    <!-- Mobile-first: serve small video by default, JS upgrades on desktop -->
    <source src={videoSrcMobile} type="video/mp4" />
  </video>

  <!-- Poster fallback for reduced motion or if video fails -->
  <img
    src={posterSrc}
    alt=""
    class="poster-fallback"
    aria-hidden="true"
  />

  <!-- Overlay gradient -->
  <div class="hero-video-overlay" aria-hidden="true"></div>

  <!-- Floating decorative shapes -->
  <FloatingShapes variant="hero" />

  <!-- Content -->
  <div class="hero-video-content">
    <h1 class="animate-fade-slide-down" style="animation-delay: 0.2s;">
      {title}
    </h1>
    <p class="animate-fade-slide-up" style="animation-delay: 0.4s;">
      {subtitle}
    </p>

    {(primaryButtonText || secondaryButtonText) && (
      <div class="hero-buttons animate-fade-slide-up" style="animation-delay: 0.6s;">
        {primaryButtonText && primaryButtonHref && (
          <a href={primaryButtonHref} class="btn-white btn-mobile-full">
            {primaryButtonText}
          </a>
        )}
        {secondaryButtonText && secondaryButtonHref && (
          <a href={secondaryButtonHref} class="btn-outline-hero btn-mobile-full">
            {secondaryButtonText}
          </a>
        )}
      </div>
    )}
  </div>

  <!-- Scroll indicator -->
  {showScrollIndicator && (
    <div class="scroll-indicator" aria-hidden="true">
      <span class="text-sm font-medium">{lang === 'de' ? 'Entdecken' : 'Explore'}</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
      </svg>
    </div>
  )}
</section>

<style>
  .hero-video {
    min-height: 100vh;
    min-height: 100dvh; /* Dynamic viewport height for mobile */
  }

  /* Video element - matches planted-website approach */
  .hero-video-element {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Poster fallback - hidden by default, shown if video fails or reduced motion */
  .poster-fallback {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }

  /* Ensure content stays above video */
  .hero-video-content {
    position: relative;
    z-index: 10;
  }

  /* Animation keyframes for content */
  @keyframes fadeSlideDown {
    0% {
      opacity: 0;
      transform: translateY(-30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeSlideUp {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-slide-down {
    opacity: 0;
    animation: fadeSlideDown 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .animate-fade-slide-up {
    opacity: 0;
    animation: fadeSlideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  /* Reduced motion: show poster, hide video */
  @media (prefers-reduced-motion: reduce) {
    .hero-video-element {
      display: none !important;
    }

    .poster-fallback {
      display: block !important;
    }

    .animate-fade-slide-down,
    .animate-fade-slide-up {
      opacity: 1;
      animation: none;
    }

    .scroll-indicator {
      animation: none;
    }
  }
</style>

<script>
  // iOS-optimized video initialization
  // Mobile-first: serves small 1.3MB video by default
  // Desktop: upgrades to larger video if screen is wide enough
  function initHeroVideo() {
    const video = document.getElementById('hero-video') as HTMLVideoElement;
    const poster = document.querySelector('.poster-fallback') as HTMLElement;

    if (!video) return;

    // Ensure muted (required for iOS autoplay)
    video.muted = true;

    // On desktop (>768px), upgrade to higher quality video
    const isDesktop = window.innerWidth > 768;
    const desktopSrc = video.dataset.srcDesktop;
    const mobileSrc = video.dataset.srcMobile;

    if (isDesktop && desktopSrc) {
      // Desktop: use larger video
      video.src = desktopSrc;
    } else if (mobileSrc) {
      // Mobile: use small optimized video (already set, but ensure it's loaded)
      video.src = mobileSrc;
    }

    // Load and play
    video.load();

    const playPromise = video.play();

    if (playPromise !== undefined) {
      playPromise.catch(() => {
        // Autoplay blocked - show poster
        if (poster) poster.style.display = 'block';
      });
    }
  }

  // Initialize on load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initHeroVideo);
  } else {
    initHeroVideo();
  }

  // Also handle Astro page transitions
  document.addEventListener('astro:page-load', initHeroVideo);
</script>
