---
import { getLangFromUrl } from '@i18n/utils';
import FloatingShapes from './FloatingShapes.astro';

interface Props {
  title: string;
  subtitle: string;
  videoSrc?: string;
  videoSrcMobile?: string;
  posterSrc?: string;
  primaryButtonText?: string;
  primaryButtonHref?: string;
  secondaryButtonText?: string;
  secondaryButtonHref?: string;
  showScrollIndicator?: boolean;
}

const base = import.meta.env.BASE_URL.replace(/\/$/, '');

const {
  title,
  subtitle,
  videoSrc = `${base}/videos/hero.mp4`,
  videoSrcMobile = `${base}/videos/hero-mobile.mp4`,
  posterSrc = `${base}/images/hero-poster.jpg`,
  primaryButtonText,
  primaryButtonHref,
  secondaryButtonText,
  secondaryButtonHref,
  showScrollIndicator = true,
} = Astro.props;

const lang = getLangFromUrl(Astro.url);
---

<section class="hero-video" aria-label={lang === 'de' ? 'Hauptbereich' : 'Hero section'}>
  <!-- Video Background - iOS Safari optimized: NO JavaScript, pure HTML autoplay -->
  <!-- Desktop video - hidden on mobile via CSS -->
  <video
    class="hero-video-element hero-video-desktop"
    autoplay
    muted
    loop
    playsinline
    poster={posterSrc}
  >
    <source src={videoSrc} type="video/mp4" />
  </video>

  <!-- Mobile video - hidden on desktop via CSS, smaller file for iOS -->
  <video
    class="hero-video-element hero-video-mobile"
    autoplay
    muted
    loop
    playsinline
    poster={posterSrc}
  >
    <source src={videoSrcMobile} type="video/mp4" />
  </video>

  <!-- Poster fallback for reduced motion or if video fails -->
  <img
    src={posterSrc}
    alt=""
    class="poster-fallback"
    aria-hidden="true"
  />

  <!-- Overlay gradient -->
  <div class="hero-video-overlay" aria-hidden="true"></div>

  <!-- Floating decorative shapes -->
  <FloatingShapes variant="hero" />

  <!-- Content -->
  <div class="hero-video-content">
    <h1 class="animate-fade-slide-down" style="animation-delay: 0.2s;">
      {title}
    </h1>
    <p class="animate-fade-slide-up" style="animation-delay: 0.4s;">
      {subtitle}
    </p>

    {(primaryButtonText || secondaryButtonText) && (
      <div class="hero-buttons animate-fade-slide-up" style="animation-delay: 0.6s;">
        {primaryButtonText && primaryButtonHref && (
          <a href={primaryButtonHref} class="btn-white btn-mobile-full">
            {primaryButtonText}
          </a>
        )}
        {secondaryButtonText && secondaryButtonHref && (
          <a href={secondaryButtonHref} class="btn-outline-hero btn-mobile-full">
            {secondaryButtonText}
          </a>
        )}
      </div>
    )}
  </div>

  <!-- Scroll indicator -->
  {showScrollIndicator && (
    <div class="scroll-indicator" aria-hidden="true">
      <span class="text-sm font-medium">{lang === 'de' ? 'Entdecken' : 'Explore'}</span>
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
      </svg>
    </div>
  )}
</section>

<style>
  .hero-video {
    min-height: 100vh;
    min-height: 100dvh; /* Dynamic viewport height for mobile */
  }

  /* Video element - matches planted-website approach */
  .hero-video-element {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  /* Mobile-first: show mobile video by default, hide desktop */
  .hero-video-desktop {
    display: none;
  }

  .hero-video-mobile {
    display: block;
  }

  /* Desktop: show desktop video, hide mobile */
  @media (min-width: 769px) {
    .hero-video-desktop {
      display: block;
    }

    .hero-video-mobile {
      display: none;
    }
  }

  /* Poster fallback - hidden by default, shown if video fails or reduced motion */
  .poster-fallback {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
  }

  /* Ensure content stays above video */
  .hero-video-content {
    position: relative;
    z-index: 10;
  }

  /* Animation keyframes for content */
  @keyframes fadeSlideDown {
    0% {
      opacity: 0;
      transform: translateY(-30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeSlideUp {
    0% {
      opacity: 0;
      transform: translateY(30px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-slide-down {
    opacity: 0;
    animation: fadeSlideDown 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  .animate-fade-slide-up {
    opacity: 0;
    animation: fadeSlideUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
  }

  /* Reduced motion: disable animations but keep video playing */
  /* Note: Video is NOT hidden because muted autoplay is accessible
     and many iOS users have Reduce Motion enabled by default */
  @media (prefers-reduced-motion: reduce) {
    /* Removed: display:none for video - was breaking iPhone playback */

    .animate-fade-slide-down,
    .animate-fade-slide-up {
      opacity: 1;
      animation: none;
    }

    .scroll-indicator {
      animation: none;
    }
  }
</style>

<script>
  // iOS Safari: NO JavaScript src manipulation - let browser handle autoplay naturally
  // The HTML already has autoplay, muted, playsinline, loop attributes
  // CSS shows/hides appropriate video based on screen size
  // This script only handles fallback if autoplay is blocked

  function handleVideoFallback() {
    const videos = document.querySelectorAll('.hero-video-element');
    const poster = document.querySelector('.poster-fallback') as HTMLElement;

    videos.forEach((video) => {
      const videoEl = video as HTMLVideoElement;

      // Ensure muted attribute is set (required for iOS autoplay)
      videoEl.muted = true;

      // If video is paused and should be playing, try to play
      // But don't call load() - that breaks iOS autoplay
      if (videoEl.paused) {
        const playPromise = videoEl.play();
        if (playPromise !== undefined) {
          playPromise.catch(() => {
            // Autoplay blocked - show poster
            if (poster) poster.style.display = 'block';
          });
        }
      }
    });
  }

  // Handle Astro page transitions (re-trigger video if needed)
  document.addEventListener('astro:page-load', handleVideoFallback);
</script>
